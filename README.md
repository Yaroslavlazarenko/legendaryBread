# Техническое Задание: Телеграм-бот для Рыбной Фермы

## 1. Цель и границы проекта

**Цель:** Создать телеграм-бот для учёта рыбы, параметров воды,
кормлений, продаж и заказов клиентов.\
Все данные хранятся в **Google Sheets**, бот работает через журнальные
листы (append-only) и расчётные сводные листы.

## 2. Роли и доступ

-   **Администратор** --- управление водоёмами, пользователями,
    товарами, корректировки, подтверждение заказов.
-   **Оператор** --- ввод кормлений, замеров DO/температуры, контрольных
    взвешиваний, продаж и перемещений рыбы.
-   **Клиент** --- просмотр каталога и оформление заказов.

## 3. Технологический стек

-   **Язык:** Python 3.11
-   **Библиотеки:** `python-telegram-bot`, `gspread`, `pydantic`,
    `loguru`, `python-dotenv`
-   **Хостинг:** Render (webhook), локально --- polling

## 4. Архитектура проекта

    /app
      /bot           # входная точка, роутинг хендлеров
      /flows         # отдельные сценарии для админа, оператора, клиента
      /sheets        # работа с Google Sheets (журналы, справочники, представления)
      /models        # Pydantic DTO для валидации
      /config        # настройки и ENV
      /utils         # утилиты, константы, логгеры
    tests/
    requirements.txt
    Dockerfile
    README.md

## 5. Структура Google Sheets

### Лист `PONDS`

  -------------------------------------------------------------------------------------
  pond_id   name     type   species   stocking_date   initial_qty   notes   is_active
  --------- -------- ------ --------- --------------- ------------- ------- -----------
  P-001     Ставок   pond   Карп      2025-04-01      1000                  TRUE
            №1                                                              

  -------------------------------------------------------------------------------------

### Лист `FISH_MOVES_LOG`

  ---------------------------------------------------------------------------------------
  ts                 pond_id       move_type        qty    reason       ref     user
  ------------------ ------------- ---------------- ------ ------------ ------- ---------
  2025-05-01T08:00   P-001         stocking         1000   стартовое            admin
                                                           зарыбление           

  ---------------------------------------------------------------------------------------

*Аналогично описываются `FEEDING_LOG`, `WATER_QUALITY_LOG`,
`WEIGHING_LOG`, `STOCK_MOVES_LOG`, `SALES_ORDERS`, `SALES_ORDER_ITEMS`.*

## 6. Основные функции бота

1.  **Регистрация пользователя** --- сбор ФИО, телефона, назначение
    роли.
2.  **Учёт кормлений** --- выбор водоёма → тип корма → масса → запись в
    журнал.
3.  **Учёт воды** --- ввод DO и температуры, алерт при выходе за порог.
4.  **Контрольные взвешивания** --- проба, средний вес.
5.  **Движения рыбы** --- продажа, гибель, перевод между водоёмами.
6.  **Учет товаров и заказов** --- номенклатура, склад, прибыль,
    клиентские заказы.
7.  **Уведомления** --- новые заказы, критические параметры воды.

## 7. Псевдокод операции замера воды

``` python
@restricted(role=["operator","admin"])
async def on_water_quality(update, ctx):
    pond = await ask_select_pond(...)
    do = await ask_float("Введите DO, мг/л (0..20)")
    t  = await ask_float("Введите температуру, °C (-2..35)")
    summary = f"{pond.name}: DO={do}, T={t}"
    if await confirm(summary):
        row = WaterQualityRow(ts=now_iso(), pond_id=pond.id, dissolved_O2_mgL=do,
                              temperature_C=t, notes="", user=update.effective_user.id)
        await sheets.logs.append_water_quality(row)
        if do < settings.DO_MIN or t < settings.TEMP_MIN or t > settings.TEMP_MAX:
            await notify_admins(f"ALERT {pond.name}: DO={do}, T={t}")
        await reply("Сохранено.")
```

## 8. Тест-план

-   **Юнит-тесты:** валидаторы чисел, формирование строк для append.
-   **Интеграция:** проверка появления строки в Google Sheets.
-   **Сценарии:** зарыбление → продажа → остаток обновлён, замеры воды с
    алертом, оформление заказа клиентом.

## 9. Нефункциональные требования

-   Запись в журналы только append.
-   Валидация чисел и диапазонов через Pydantic.
-   Логи ошибок в `ERROR_LOG`.
-   Уведомления в чат админа.
